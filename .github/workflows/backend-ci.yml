name: Backend CI/CD

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'auth-service/**'
      - 'user-service/**'
      - 'team-service/**'
      - 'event-service/**'
      - 'workout-service/**'
  pull_request:
    branches: [ main ]

jobs:
  lint-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [auth-service, user-service, team-service, event-service, workout-service]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24' # Matches your Dockerfile

      - name: Build Check
        working-directory: ${{ matrix.service }}
        run: go build ./cmd/main.go

      - name: Run Tests
        working-directory: ${{ matrix.service }}
        run: go test ./...

  docker-build-push:
    needs: lint-test
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [auth-service, user-service, team-service, event-service, workout-service]
    steps:
      - uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ./${{ matrix.service }}
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/sports-app-${{ matrix.service }}:latest
            ${{ secrets.DOCKER_USERNAME }}/sports-app-${{ matrix.service }}:${{ github.sha }}

  deploy:
    needs: docker-build-push
    runs-on: ubuntu-latest
    steps:
      - name: Install kubectl
        uses: azure/setup-kubectl@v4

      - name: Configure Kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Deploy & Force Update
        run: |
          # 1. Apply generic manifests (ConfigMaps, Secrets, Services)
          kubectl apply -f k8s/config/ -n sports-app
          
          # 2. Update specific images to the new SHA (This forces K8s to pull)
          kubectl set image deployment/auth-service auth-service=${{ secrets.DOCKER_USERNAME }}/sports-app-auth-service:${{ github.sha }} -n sports-app
          kubectl set image deployment/user-service user-service=${{ secrets.DOCKER_USERNAME }}/sports-app-user-service:${{ github.sha }} -n sports-app
          kubectl set image deployment/team-service team-service=${{ secrets.DOCKER_USERNAME }}/sports-app-team-service:${{ github.sha }} -n sports-app
          kubectl set image deployment/event-service event-service=${{ secrets.DOCKER_USERNAME }}/sports-app-event-service:${{ github.sha }} -n sports-app
          kubectl set image deployment/workout-service workout-service=${{ secrets.DOCKER_USERNAME }}/sports-app-workout-service:${{ github.sha }} -n sports-app